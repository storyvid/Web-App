<!DOCTYPE html>
<html>
<head>
    <title>Download Fix Test</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body>
    <h1>Download Fix Test</h1>
    <div id="status">Initializing...</div>
    <button onclick="testDownload()" style="margin: 10px;">Test Download</button>
    <div id="logs" style="margin-top: 20px; background: #f0f0f0; padding: 10px; white-space: pre-wrap; font-family: monospace;"></div>
    
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCyw1Uhr9JCTbc3aq2Pz_Fxx4JQQmq9p6s",
            authDomain: "storyvidportal.firebaseapp.com",
            projectId: "storyvidportal",
            storageBucket: "storyvidportal.firebasestorage.app",
            messagingSenderId: "802482346328",
            appId: "1:802482346328:web:29b3494c816e2728c6ad2d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const storage = firebase.storage();

        function log(message) {
            const logs = document.getElementById('logs');
            logs.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        // Sign in the test admin user
        auth.signInWithEmailAndPassword('admin@test.com', 'test123')
            .then(user => {
                document.getElementById('status').textContent = 'Signed in as: ' + user.user.email;
                log('‚úÖ Authenticated as: ' + user.user.email);
            })
            .catch(error => {
                document.getElementById('status').textContent = 'Auth error: ' + error.message;
                log('‚ùå Auth error: ' + error.message);
            });

        async function testDownload() {
            try {
                log('üîç Looking for files to test download...');
                
                // Get the first file from the files collection
                const filesSnapshot = await firestore.collection('files').limit(1).get();
                
                if (filesSnapshot.empty) {
                    log('‚ùå No files found to test download');
                    return;
                }

                const fileDoc = filesSnapshot.docs[0];
                const fileData = fileDoc.data();
                const fileId = fileDoc.id;
                
                log('üìÅ Testing download for file: ' + fileData.name);
                log('üìä File details: ' + JSON.stringify({
                    name: fileData.name,
                    type: fileData.type,
                    status: fileData.status,
                    hasStoragePath: !!fileData.storagePath,
                    downloadURL: fileData.downloadURL ? 'present' : 'missing'
                }, null, 2));

                // Test the download logic similar to our Firebase service
                let downloadURL = fileData.downloadURL;
                let needsCleanup = false;

                if (fileData.status === 'base64-stored' || fileData.downloadURL?.startsWith('data:')) {
                    log('üìÅ File is base64-stored, using data URL directly');
                } else if (fileData.storagePath) {
                    log('üìÅ File is in Firebase Storage, downloading as blob...');
                    try {
                        const storageRef = storage.ref(fileData.storagePath);
                        const blob = await storageRef.getBlob();
                        downloadURL = URL.createObjectURL(blob);
                        needsCleanup = true;
                        log('‚úÖ Successfully created blob URL for download');
                    } catch (blobError) {
                        log('‚ö†Ô∏è Could not get blob from Firebase Storage: ' + blobError.message);
                        log('üîÑ Falling back to direct URL');
                    }
                } else {
                    log('üìÅ File has download URL but no storage path, using direct URL');
                }

                // Test the actual download
                log('‚¨áÔ∏è Triggering download...');
                const link = document.createElement('a');
                link.href = downloadURL;
                link.download = fileData.name;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                log('‚úÖ Download triggered successfully for: ' + fileData.name);
                
                // Clean up if needed
                if (needsCleanup) {
                    setTimeout(() => {
                        log('üßπ Cleaning up blob URL');
                        URL.revokeObjectURL(downloadURL);
                    }, 1000);
                }

            } catch (error) {
                log('‚ùå Download test failed: ' + error.message);
                console.error('Download test error:', error);
            }
        }
    </script>
</body>
</html>